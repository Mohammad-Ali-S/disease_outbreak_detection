<!-- templates/admin_bulk_import.html -->
{% extends "base.html" %}

{% block title %}Bulk Data Import - DODS{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem; color: #667eea;">üì§ Bulk Data Import</h1>

<div class="card">
    <div class="card-header">Hospital Data Integration</div>
    <p style="margin-bottom: 1.5rem;">
        Import patient data from hospitals in CSV format. The system will automatically process and integrate the data.
    </p>
    
    <div style="background: #e3f2fd; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
        <h3 style="color: #1976d2; margin-bottom: 1rem;">üìã Required CSV Format</h3>
        <p><strong>Required columns:</strong></p>
        <code style="display: block; background: white; padding: 1rem; margin: 1rem 0; border-radius: 5px;">
            patient_id, name, age, gender, city, state, latitude, longitude, disease_type, diagnosis_date, severity, status
        </code>
        
        <p style="margin-top: 1rem;"><strong>Optional columns:</strong></p>
        <code style="display: block; background: white; padding: 1rem; margin: 1rem 0; border-radius: 5px;">
            contact, address, country, symptoms, vaccination_status, test_type, test_result, cd4_count, viral_load, etc.
        </code>
        
        <div style="margin-top: 1rem;">
            <a href="/static/sample_template.csv" class="btn btn-primary" download>üì• Download Sample Template</a>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">Upload CSV File</div>
    
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="csvFile">Select CSV File *</label>
            <input type="file" id="csvFile" name="file" accept=".csv" required style="padding: 1rem; border: 2px dashed #667eea;">
        </div>
        
        <div id="fileInfo" style="margin: 1rem 0; display: none;">
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                <p><strong>File:</strong> <span id="fileName"></span></p>
                <p><strong>Size:</strong> <span id="fileSize"></span></p>
                <p><strong>Status:</strong> <span id="fileStatus">Ready to upload</span></p>
            </div>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button type="submit" class="btn btn-primary" id="uploadBtn">
                üì§ Upload and Import
            </button>
            <button type="button" class="btn btn-danger" onclick="document.getElementById('csvFile').value=''; document.getElementById('fileInfo').style.display='none';">
                Clear
            </button>
        </div>
    </form>
    
    <div id="progressBar" style="display: none; margin-top: 2rem;">
        <div style="background: #e9ecef; border-radius: 10px; height: 30px; overflow: hidden;">
            <div id="progress" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                0%
            </div>
        </div>
        <p id="progressText" style="margin-top: 0.5rem; text-align: center; color: #666;"></p>
    </div>
</div>

<div class="card">
    <div class="card-header">Import History</div>
    <div id="importResults" style="min-height: 200px;">
        <p style="color: #999; text-align: center; padding: 3rem;">No imports yet</p>
    </div>
</div>

<div class="card">
    <div class="card-header">üéØ Dummy Datasets Available</div>
    <p>Download pre-generated dummy datasets (10,000 records each):</p>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <button class="btn btn-success" onclick="generateDataset('covid19')">
            ü¶† COVID-19 Dataset
        </button>
        <button class="btn btn-success" onclick="generateDataset('cholera')">
            üíß Cholera Dataset
        </button>
        <button class="btn btn-success" onclick="generateDataset('hiv')">
            üî¨ HIV/AIDS Dataset
        </button>
        <button class="btn btn-success" onclick="generateDataset('swineflu')">
            üê∑ Swine Flu Dataset
        </button>
    </div>
    <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
        Note: Run <code>python bulk_data_loader.py</code> to generate these datasets first.
    </p>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(2) + ' KB';
            document.getElementById('fileStatus').textContent = 'Ready to upload';
        }
    });
    
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('csvFile');
        const file = fileInput.files[0];
        
        if (!file) {
            showAlert('Please select a file', 'danger');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        
        // Show progress
        document.getElementById('progressBar').style.display = 'block';
        document.getElementById('uploadBtn').disabled = true;
        updateProgress(10, 'Uploading file...');
        
        try {
            const response = await fetch('/admin/bulk-import', {
                method: 'POST',
                body: formData
            });
            
            updateProgress(50, 'Processing data...');
            
            const result = await response.json();
            
            updateProgress(100, 'Complete!');
            
            if (result.success) {
                showAlert(`Import successful! Patients: ${result.patients_added}, Records: ${result.records_added}`, 'success');
                
                // Show results
                let resultsHTML = `
                    <div style="background: #d4edda; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h4 style="margin-bottom: 1rem;">‚úÖ Import Completed</h4>
                        <p><strong>Patients Added:</strong> ${result.patients_added}</p>
                        <p><strong>Disease Records Added:</strong> ${result.records_added}</p>
                        <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
                `;
                
                if (result.errors && result.errors.length > 0) {
                    resultsHTML += `<p style="margin-top: 1rem;"><strong>Errors:</strong></p><ul>`;
                    result.errors.forEach(err => {
                        resultsHTML += `<li style="color: #721c24;">${err}</li>`;
                    });
                    resultsHTML += `</ul>`;
                }
                
                resultsHTML += `</div>`;
                
                document.getElementById('importResults').innerHTML = resultsHTML;
                
                // Clear form
                fileInput.value = '';
                document.getElementById('fileInfo').style.display = 'none';
                
                setTimeout(() => {
                    if (confirm('Import completed! Run ETL pipeline now to update analytics?')) {
                        window.location.href = '/admin/data-warehouse';
                    }
                }, 2000);
                
            } else {
                showAlert(result.message || 'Import failed', 'danger');
            }
            
        } catch (error) {
            console.error('Error:', error);
            showAlert('Error uploading file: ' + error.message, 'danger');
        } finally {
            document.getElementById('uploadBtn').disabled = false;
            setTimeout(() => {
                document.getElementById('progressBar').style.display = 'none';
            }, 3000);
        }
    });
    
    function updateProgress(percent, text) {
        const bar = document.getElementById('progress');
        bar.style.width = percent + '%';
        bar.textContent = percent + '%';
        document.getElementById('progressText').textContent = text;
    }
    
    function generateDataset(disease) {
        showAlert('Please run: python bulk_data_loader.py to generate datasets', 'info');
    }
</script>
{% endblock %}
