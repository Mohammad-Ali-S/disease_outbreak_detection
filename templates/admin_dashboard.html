<!-- templates/admin_dashboard.html -->
{% extends "base.html" %}

{% block title %}Admin Dashboard - DODS{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem; color: #667eea;">ðŸ“Š Admin Dashboard</h1>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" id="total-patients">{{ stats.total_patients }}</div>
        <div class="stat-label">Total Patients</div>
    </div>
    
    <div class="stat-card success">
        <div class="stat-value" id="total-cases">{{ stats.total_cases }}</div>
        <div class="stat-label">Total Cases</div>
    </div>
    
    <div class="stat-card warning">
        <div class="stat-value" id="active-alerts">{{ stats.active_alerts }}</div>
        <div class="stat-label">Active Alerts</div>
    </div>
    
    <div class="stat-card info">
        <div class="stat-value" id="disease-count">{{ stats.disease_breakdown|length }}</div>
        <div class="stat-label">Diseases Tracked</div>
    </div>
</div>

<div class="card">
    <div class="card-header">Disease Distribution</div>
    <div class="chart-container">
        <canvas id="diseaseChart"></canvas>
    </div>
</div>

<div class="card">
    <div class="card-header">30-Day Trend Analysis</div>
    <div class="chart-container">
        <canvas id="trendChart"></canvas>
    </div>
</div>

<div class="card">
    <div class="card-header">Quick Actions</div>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="runETL()">
            ðŸ”„ Run ETL Pipeline
        </button>
        <button class="btn btn-success" onclick="generateReport()">
            ðŸ“„ Generate Report
        </button>
        <button class="btn btn-primary" onclick="window.location.href='/admin/analytics'">
            ðŸ“ˆ View Analytics
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load dashboard data
    async function loadDashboardData() {
        try {
            const response = await fetch('/api/dashboard-stats');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Update stats
            document.getElementById('total-patients').textContent = formatNumber(data.total_patients);
            document.getElementById('total-cases').textContent = formatNumber(data.total_cases);
            document.getElementById('active-alerts').textContent = formatNumber(data.active_cases);
            
            // Create charts
            if (data.disease_breakdown && data.disease_breakdown.length > 0) {
                createDiseaseChart(data.disease_breakdown);
            } else {
                console.log('No disease data available for chart');
            }
            
            if (data.trend_data && data.trend_data.length > 0) {
                createTrendChart(data.trend_data);
            } else {
                console.log('No trend data available for chart');
            }
            
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            showAlert('Error loading dashboard data: ' + error.message, 'danger');
        }
    }
    
    function createDiseaseChart(diseaseData) {
        const ctx = document.getElementById('diseaseChart');
        if (!ctx) return;
        
        // Destroy existing chart if any
        const existingChart = Chart.getChart(ctx);
        if (existingChart) {
            existingChart.destroy();
        }
        
        const labels = diseaseData.map(d => d.disease);
        const active = diseaseData.map(d => d.active || 0);
        const recovered = diseaseData.map(d => d.recovered || 0);
        const deaths = diseaseData.map(d => d.deaths || 0);
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Active',
                        data: active,
                        backgroundColor: 'rgba(255, 99, 132, 0.7)'
                    },
                    {
                        label: 'Recovered',
                        data: recovered,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)'
                    },
                    {
                        label: 'Deaths',
                        data: deaths,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true }
                }
            }
        });
    }
    
    function createTrendChart(trendData) {
        const ctx = document.getElementById('trendChart');
        if (!ctx) return;
        
        // Destroy existing chart if any
        const existingChart = Chart.getChart(ctx);
        if (existingChart) {
            existingChart.destroy();
        }
        
        const labels = trendData.map(d => formatDate(d.date));
        const counts = trendData.map(d => d.count);
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Daily Cases',
                    data: counts,
                    borderColor: 'rgb(102, 126, 234)',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
    
    async function runETL() {
        if (!confirm('Run ETL pipeline? This may take a few minutes.')) return;
        
        try {
            showAlert('Running ETL pipeline...', 'info');
            
            const response = await fetch('/api/data-warehouse/run-etl', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('ETL pipeline completed successfully!', 'success');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showAlert(result.message || 'ETL failed', 'danger');
            }
        } catch (error) {
            console.error('Error running ETL:', error);
            showAlert('Error running ETL pipeline: ' + error.message, 'danger');
        }
    }
    
    function generateReport() {
        window.location.href = '/api/export-data/csv';
    }
    
    // Load data on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadDashboardData);
    } else {
        loadDashboardData();
    }
    
    // Auto-refresh every 5 minutes
    setInterval(loadDashboardData, 300000);
</script>
{% endblock %}