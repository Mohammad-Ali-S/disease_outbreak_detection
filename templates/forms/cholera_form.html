<!-- templates/forms/cholera_form.html -->
{% extends "base.html" %}

{% block title %}Cholera Report Form - DODS{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem; color: #667eea;">ðŸ’§ Cholera Disease Report</h1>

<div class="card">
    <form id="choleraForm">
        <input type="hidden" name="disease_type" value="Cholera">
        
        <h3 style="color: #667eea; margin-bottom: 1rem;">Basic Information</h3>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div class="form-group">
                <label for="diagnosis_date">Diagnosis Date *</label>
                <input type="date" id="diagnosis_date" name="diagnosis_date" required>
            </div>
            
            <div class="form-group">
                <label for="severity">Severity *</label>
                <select id="severity" name="severity" required>
                    <option value="">Select Severity</option>
                    <option value="Mild">Mild (Mild diarrhea)</option>
                    <option value="Moderate">Moderate (Frequent watery stool)</option>
                    <option value="Severe">Severe (Severe dehydration)</option>
                    <option value="Critical">Critical (Shock/Renal failure)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="status">Status *</label>
                <select id="status" name="status" required>
                    <option value="Active">Active</option>
                    <option value="Recovered">Recovered</option>
                    <option value="Deceased">Deceased</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="admission_status">Admission Status</label>
                <select id="admission_status" name="admission_status">
                    <option value="Outpatient">Outpatient</option>
                    <option value="Inpatient">Inpatient</option>
                    <option value="ICU">ICU</option>
                </select>
            </div>
        </div>
        
        <h3 style="color: #667eea; margin: 2rem 0 1rem;">Clinical Symptoms</h3>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <label><input type="checkbox" name="symptom" value="watery_diarrhea"> Watery Diarrhea (Rice water stool)</label>
            <label><input type="checkbox" name="symptom" value="vomiting"> Vomiting</label>
            <label><input type="checkbox" name="symptom" value="dehydration"> Dehydration</label>
            <label><input type="checkbox" name="symptom" value="muscle_cramps"> Muscle Cramps</label>
            <label><input type="checkbox" name="symptom" value="rapid_heart_rate"> Rapid Heart Rate</label>
            <label><input type="checkbox" name="symptom" value="low_blood_pressure"> Low Blood Pressure</label>
            <label><input type="checkbox" name="symptom" value="thirst"> Excessive Thirst</label>
            <label><input type="checkbox" name="symptom" value="dry_mucous"> Dry Mucous Membranes</label>
        </div>
        
        <h3 style="color: #667eea; margin: 2rem 0 1rem;">Stool Characteristics</h3>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div class="form-group">
                <label for="stool_frequency">Stool Frequency (per day)</label>
                <input type="number" id="stool_frequency" name="stool_frequency" min="0">
            </div>
            
            <div class="form-group">
                <label for="stool_type">Stool Appearance</label>
                <select id="stool_type" name="stool_type">
                    <option value="Rice water">Rice water appearance</option>
                    <option value="Watery">Watery</option>
                    <option value="Loose">Loose</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="stool_volume">Estimated Volume (ml/day)</label>
                <input type="number" id="stool_volume" name="stool_volume" min="0">
            </div>
            
            <div class="form-group">
                <label for="blood_in_stool">Blood in Stool</label>
                <select id="blood_in_stool" name="blood_in_stool">
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                </select>
            </div>
        </div>
        
        <h3 style="color: #667eea; margin: 2rem 0 1rem;">Dehydration Assessment</h3>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div class="form-group">
                <label for="dehydration_level">Dehydration Level</label>
                <select id="dehydration_level" name="dehydration_level">
                    <option value="None">None/Minimal</option>
                    <option value="Mild">Mild (3-5% loss)</option>
                    <option value="Moderate">Moderate (6-9% loss)</option>
                    <option value="Severe">Severe (>10% loss)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="skin_turgor">Skin Turgor</label>
                <select id="skin_turgor" name="skin_turgor">
                    <option value="Normal">Normal</option>
                    <option value="Reduced">Reduced</option>
                    <option value="Poor">Poor (>2 seconds)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="capillary_refill">Capillary Refill Time (seconds)</label>
                <input type="number" id="capillary_refill" name="capillary_refill" step="0.1">
            </div>
            
            <div class="form-group">
                <label for="mental_status">Mental Status</label>
                <select id="mental_status" name="mental_status">
                    <option value="Alert">Alert and Oriented</option>
                    <option value="Lethargic">Lethargic</option>
                    <option value="Unconscious">Unconscious/Comatose</option>
                </select>
            </div>
        </div>
        
        <h3 style="color: #667eea; margin: 2rem 0 1rem;">Laboratory Results</h3>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div class="form-group">
                <label for="stool_culture">Stool Culture Result</label>
                <select id="stool_culture" name="stool_culture">
                    <option value="Pending">Pending</option>
                    <option value="Positive">Positive (V. cholerae detected)</option>
                    <option value="Negative">Negative</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="serotype">Serotype (if positive)</label>
                <select id="serotype" name="serotype">
                    <option value="">Not determined</option>
                    <option value="O1">O1 (El Tor/Classical)</option>
                    <option value="O139">O139</option>
                    <option value="Non-O1/O139">Non-O1/O139</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="rapid_test">Rapid Diagnostic Test</label>
                <select id="rapid_test" name="rapid_test">
                    <option value="Not done">Not done</option>
                    <option value="Positive">Positive</option>
                    <option value="Negative">Negative</option>
                </select>
            </div>
        </div>
        
        <h3 style="color: #667eea; margin: 2rem 0 1rem;">Epidemiological Data</h3>
        
        <div class="form-group">
            <label for="water_source">Water Source</label>
            <textarea id="water_source" name="water_source" rows="2" placeholder="Describe primary water source"></textarea>
        </div>
        
        <div class="form-group">
            <label for="food_history">Recent Food History (last 5 days)</label>
            <textarea id="food_history" name="food_history" rows="2"></textarea>
        </div>
        
        <div class="form-group">
            <label for="contact_with_cases">Contact with Other Cases</label>
            <textarea id="contact_with_cases" name="contact_with_cases" rows="2"></textarea>
        </div>
        
        <h3 style="color: #667eea; margin: 2rem 0 1rem;">Treatment</h3>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div class="form-group">
                <label for="rehydration_type">Rehydration Method</label>
                <select id="rehydration_type" name="rehydration_type">
                    <option value="ORS">ORS (Oral Rehydration Solution)</option>
                    <option value="IV fluids">IV Fluids</option>
                    <option value="Both">Both ORS and IV</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="fluid_volume">Fluid Volume Given (liters)</label>
                <input type="number" id="fluid_volume" name="fluid_volume" step="0.1">
            </div>
            
            <div class="form-group">
                <label for="antibiotic">Antibiotic Given</label>
                <input type="text" id="antibiotic" name="antibiotic" placeholder="e.g., Doxycycline, Azithromycin">
            </div>
            
            <div class="form-group">
                <label for="zinc_supplementation">Zinc Supplementation</label>
                <select id="zinc_supplementation" name="zinc_supplementation">
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label for="notes">Additional Notes</label>
            <textarea id="notes" name="notes" rows="4"></textarea>
        </div>
        
        <div style="margin-top: 2rem;">
            <button type="submit" class="btn btn-primary">Submit Report</button>
            <button type="button" class="btn btn-danger" onclick="history.back()">Cancel</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('diagnosis_date').valueAsDate = new Date();
    
    document.getElementById('choleraForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Get patient ID from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const patientId = urlParams.get('patient_id');
        
        if (!patientId) {
            showAlert('Error: No patient selected', 'danger');
            return;
        }
        
        const symptoms = Array.from(document.querySelectorAll('input[name="symptom"]:checked'))
            .map(cb => cb.value);
        
        const formData = {
            disease_type: 'Cholera',
            diagnosis_date: document.getElementById('diagnosis_date').value,
            severity: document.getElementById('severity').value,
            status: document.getElementById('status').value,
            symptoms: { list: symptoms },
            test_results: {
                stool_frequency: document.getElementById('stool_frequency').value,
                stool_type: document.getElementById('stool_type').value,
                stool_volume: document.getElementById('stool_volume').value,
                blood_in_stool: document.getElementById('blood_in_stool').value,
                dehydration_level: document.getElementById('dehydration_level').value,
                skin_turgor: document.getElementById('skin_turgor').value,
                capillary_refill: document.getElementById('capillary_refill').value,
                mental_status: document.getElementById('mental_status').value,
                stool_culture: document.getElementById('stool_culture').value,
                serotype: document.getElementById('serotype').value,
                rapid_test: document.getElementById('rapid_test').value
            },
            travel_history: {
                water_source: document.getElementById('water_source').value,
                food_history: document.getElementById('food_history').value
            },
            contact_history: {
                details: document.getElementById('contact_with_cases').value
            },
            treatment: {
                admission_status: document.getElementById('admission_status').value,
                rehydration_type: document.getElementById('rehydration_type').value,
                fluid_volume: document.getElementById('fluid_volume').value,
                antibiotic: document.getElementById('antibiotic').value,
                zinc_supplementation: document.getElementById('zinc_supplementation').value
            },
            notes: document.getElementById('notes').value
        };
        
        try {
            const response = await fetch(`/user/add-disease-record/${patientId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('Cholera report submitted successfully!', 'success');
                setTimeout(() => window.location.href = '/user/dashboard', 2000);
            } else {
                showAlert('Error submitting report', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Error submitting report: ' + error.message, 'danger');
        }
    });
</script>
{% endblock %}
