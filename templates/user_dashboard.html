<!-- templates/user_dashboard.html -->
{% extends "base.html" %}

{% block title %}User Dashboard - DODS{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem; color: #667eea;">ğŸ‘¤ User Dashboard</h1>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" id="recentCases">{{ recent_cases|length }}</div>
        <div class="stat-label">Recent Cases Reported</div>
    </div>
    
    <div class="stat-card success">
        <div class="stat-value" id="todayCases">0</div>
        <div class="stat-label">Cases Today</div>
    </div>
    
    <div class="stat-card info">
        <div class="stat-value">4</div>
        <div class="stat-label">Diseases Tracked</div>
    </div>
</div>

<div class="card">
    <div class="card-header">Quick Actions</div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <button class="btn btn-primary" onclick="window.location.href='/user/add-patient'" style="padding: 1.5rem; font-size: 1.1rem;">
            â• Add New Patient
        </button>
        <button class="btn btn-success" onclick="viewAnalytics()" style="padding: 1.5rem; font-size: 1.1rem;">
            ğŸ“Š View Analytics
        </button>
        <button class="btn btn-primary" onclick="showReports()" style="padding: 1.5rem; font-size: 1.1rem;">
            ğŸ“„ My Reports
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">Recent Disease Reports</div>
    
    {% if recent_cases %}
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Patient</th>
                    <th>Disease</th>
                    <th>Severity</th>
                    <th>Status</th>
                    <th>Risk Score</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for case in recent_cases %}
                <tr>
                    <td>{{ case.diagnosis_date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ case.patient.name }}<br><small>{{ case.patient.patient_id }}</small></td>
                    <td>
                        <span style="background: 
                            {% if case.disease_type == 'COVID19' %}#ff6b6b
                            {% elif case.disease_type == 'Cholera' %}#4ecdc4
                            {% elif case.disease_type == 'HIV' %}#95e1d3
                            {% else %}#ffa07a{% endif %}; 
                            color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.85rem;">
                            {{ case.disease_type }}
                        </span>
                    </td>
                    <td>
                        <span style="background: 
                            {% if case.severity == 'Critical' %}#dc3545
                            {% elif case.severity == 'Severe' %}#ff6b6b
                            {% elif case.severity == 'Moderate' %}#ffa500
                            {% else %}#4facfe{% endif %}; 
                            color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.85rem;">
                            {{ case.severity or 'N/A' }}
                        </span>
                    </td>
                    <td>{{ case.status }}</td>
                    <td>{{ (case.outbreak_risk_score * 100)|round(1) if case.outbreak_risk_score else 'N/A' }}%</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewCase({{ case.id }})" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                            View
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 3rem; color: #999;">
        <h3>No recent cases</h3>
        <p>Start by adding a new patient and disease report</p>
        <button class="btn btn-primary" onclick="window.location.href='/user/add-patient'" style="margin-top: 1rem;">
            Add First Patient
        </button>
    </div>
    {% endif %}
</div>

<div class="card">
    <div class="card-header">Disease Distribution</div>
    <div class="chart-container">
        <canvas id="diseaseChart"></canvas>
    </div>
</div>

<div class="card">
    <div class="card-header">System Information</div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
        <div>
            <h4 style="color: #667eea; margin-bottom: 0.5rem;">ğŸ“‹ Supported Diseases</h4>
            <ul style="list-style: none; padding-left: 0;">
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #eee;">ğŸ¦  COVID-19</li>
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #eee;">ğŸ’§ Cholera</li>
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #eee;">ğŸ”¬ HIV/AIDS</li>
                <li style="padding: 0.5rem 0;">ğŸ· Swine Flu</li>
            </ul>
        </div>
        
        <div>
            <h4 style="color: #667eea; margin-bottom: 0.5rem;">ğŸ¤– ML Features</h4>
            <ul style="list-style: none; padding-left: 0;">
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #eee;">âœ“ Outbreak Prediction</li>
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #eee;">âœ“ Spatial Clustering</li>
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #eee;">âœ“ Risk Assessment</li>
                <li style="padding: 0.5rem 0;">âœ“ Time Series Forecasting</li>
            </ul>
        </div>
        
        <div>
            <h4 style="color: #667eea; margin-bottom: 0.5rem;">ğŸ“Š Analytics Available</h4>
            <ul style="list-style: none; padding-left: 0;">
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #eee;">âœ“ Interactive Maps</li>
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #eee;">âœ“ Trend Analysis</li>
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #eee;">âœ“ Hotspot Detection</li>
                <li style="padding: 0.5rem 0;">âœ“ Frequency Charts</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadDashboardData() {
        try {
            const response = await fetch('/api/dashboard-stats');
            const data = await response.json();
            
            // Update today's cases
            const today = new Date().toISOString().split('T')[0];
            const todayData = data.trend_data.find(d => d.date === today);
            document.getElementById('todayCases').textContent = todayData ? todayData.count : 0;
            
            // Create disease chart
            if (data.disease_breakdown && data.disease_breakdown.length > 0) {
                createDiseaseChart(data.disease_breakdown);
            }
        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    }
    
    function createDiseaseChart(diseaseData) {
        const ctx = document.getElementById('diseaseChart');
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: diseaseData.map(d => d.disease),
                datasets: [{
                    data: diseaseData.map(d => d.total),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Disease Distribution'
                    }
                }
            }
        });
    }
    
    function viewCase(caseId) {
        // In production, show case details modal
        alert(`View case details for ID: ${caseId}`);
    }
    
    function viewAnalytics() {
        window.location.href = '/admin/analytics';
    }
    
    function showReports() {
        alert('Reports feature - would show user\'s submitted reports');
    }
    
    // Load data on page load
    loadDashboardData();
</script>
{% endblock %}